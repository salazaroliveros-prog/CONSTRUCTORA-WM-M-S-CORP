<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#001326">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>M&S - Recursos Humanos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="executive-theme.css">
    <script src="database.js"></script>
    <script src="sync.js"></script>
    <script defer src="pwa.js"></script>
    <style>
        /* Estilos generales consistentes con otras herramientas */
        :root {
            --azul-marino: #001f3f;
            --amarillo-mostaza: #FFD700;
            --gris-oscuro: #333333;
            --gris-claro: #f4f4f4;
            --verde: #2ecc71;
            --rojo: #e74c3c;
            --naranja: #e67e22;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--gris-oscuro) 0%, #000 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Encabezado consistente */
        .header {
            background: linear-gradient(90deg, var(--azul-marino) 0%, #002851 100%);
            color: var(--amarillo-mostaza);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: var(--amarillo-mostaza);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--azul-marino);
            font-size: 1.5rem;
        }
        
        .titulo {
            font-size: 1.4rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .eslogan {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 3px;
        }
        
        .reloj-fecha {
            text-align: right;
            font-size: 0.9rem;
        }
        
        /* Contenedor principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Filtros */
        .filtros {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        .filtro-grupo {
            margin-bottom: 15px;
        }
        
        .filtro-grupo label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--amarillo-mostaza);
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 1rem;
        }
        
        /* Botones de navegación */
        .botones-navegacion {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .btn-inicio {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }
        
        .btn-dashboard {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }
        
        .btn-guardar {
            background: linear-gradient(90deg, #27ae60, #219653);
        }
        
        .btn-sincronizar {
            background: linear-gradient(90deg, #e67e22, #d35400);
        }
        
        .btn-imprimir {
            background: linear-gradient(90deg, #34495e, #2c3e50);
        }
        
        .btn-salir {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }
        
        /* Secciones */
        .seccion {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            display: none;
        }
        
        .seccion.activa {
            display: block;
        }
        
        .seccion-titulo {
            color: var(--amarillo-mostaza);
            border-bottom: 2px solid var(--amarillo-mostaza);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        /* Formulario de contratación */
        .formulario-contratacion {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .campo-formulario {
            margin-bottom: 20px;
        }
        
        .campo-formulario label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ddd;
        }
        
        .campo-formulario input, 
        .campo-formulario select, 
        .campo-formulario textarea {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.5);
            color: white;
        }
        
        .campo-formulario textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Puestos disponibles */
        .puestos-disponibles {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .puesto-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .puesto-item:last-child {
            border-bottom: none;
        }
        
        .puesto-disponible {
            color: var(--verde);
        }
        
        .puesto-no-disponible {
            color: var(--rojo);
            opacity: 0.6;
        }
        
        /* Firma digital */
        .firma-container {
            margin-top: 20px;
        }
        
        .canvas-contenedor {
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 8px;
            background: white;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        canvas {
            width: 100%;
            height: 200px;
            display: block;
            cursor: crosshair;
        }
        
        .controles-firma {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .acciones-botones {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn-firma {
            padding: 10px 20px;
            background: var(--azul-marino);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Checkbox de aceptación */
        .aceptacion {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* Lista de aplicantes */
        .lista-aplicantes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .aplicante-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .aplicante-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .estado-contrato {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .estado-pendiente {
            background: #f39c12;
            color: black;
        }
        
        .estado-aprobado {
            background: var(--verde);
            color: white;
        }
        
        .estado-rechazado {
            background: var(--rojo);
            color: white;
        }
        
        /* Mapa de ubicación */
        .mapa-container {
            height: 400px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .mapa-placeholder {
            width: 100%;
            height: 100%;
            display: block;
            background: #1f2a35;
            color: white;
            position: relative;
        }

        .rrhh-map-canvas {
            width: 100%;
            height: 100%;
        }

        .rrhh-map-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.55);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            color: #fff;
            font-weight: 600;
        }

        .rrhh-map-controls {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .rrhh-muted {
            opacity: 0.85;
            font-size: 0.9rem;
        }
        
        /* Planilla */
        .tabla-planilla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .tabla-planilla th {
            background: var(--azul-marino);
            color: var(--amarillo-mostaza);
            padding: 15px;
            text-align: left;
        }
        
        .tabla-planilla td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tabla-planilla tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        /* Notificaciones */
        .notificaciones {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 300px;
            z-index: 2000;
        }
        
        .notificacion {
            background: rgba(0, 0, 0, 0.9);
            border-left: 5px solid;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .notificacion.alerta {
            border-left-color: #f39c12;
        }
        
        .notificacion.exito {
            border-left-color: var(--verde);
        }
        
        .notificacion.error {
            border-left-color: var(--rojo);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .botones-navegacion {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .formulario-contratacion {
                grid-template-columns: 1fr;
            }
            
            .lista-aplicantes {
                grid-template-columns: 1fr;
            }
            
            .reloj-fecha {
                text-align: center;
            }
        }
        
        /* Estilos para pestañas */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: none;
        }
        
        .tab.activa {
            background: rgba(255, 215, 0, 0.2);
            color: var(--amarillo-mostaza);
            border-color: var(--amarillo-mostaza);
        }
        
        /* Botón de selfie */
        .selfie-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .selfie-preview {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 3px solid var(--amarillo-mostaza);
            object-fit: cover;
            margin: 0 auto 15px;
            display: none;
        }
        
        #videoElement {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            border: 2px solid var(--amarillo-mostaza);
            margin-bottom: 15px;
        }
        
        /* Estilos para trabajadores en mapa */
        .trabajador-mapa {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
            transform: translate(-50%, -50%);
        }
        
        .trabajador-verde {
            background: var(--verde);
        }
        
        .trabajador-rojo {
            background: var(--rojo);
        }
    </style>
</head>
<body class="exec-app">
    <!-- Encabezado -->
    <header class="header">
        <div class="logo-container">
            <div class="logo">M&S</div>
            <div>
                <div class="titulo">CONSTRUCTORA WM/M&S - Recursos Humanos</div>
                <div class="eslogan">EDIFICANDO EL FUTURO</div>
            </div>
        </div>
        <div class="reloj-fecha">
            <div id="fechaActual"></div>
            <div id="horaActual"></div>
        </div>
    </header>

    <!-- Contenedor principal -->
    <div class="container">
        <!-- Filtros -->
        <div class="filtros">
            <div class="filtro-grupo">
                <label for="filtroProyecto"><i class="fas fa-project-diagram"></i> Seleccionar Proyecto</label>
                <select id="filtroProyecto">
                    <option value="">-- Seleccionar proyecto --</option>
                </select>
            </div>
            
            <div class="filtro-grupo">
                <label for="filtroEstado"><i class="fas fa-filter"></i> Filtrar por Estado</label>
                <select id="filtroEstado">
                    <option value="todos">Todos los estados</option>
                    <option value="pendiente">Pendientes de revisión</option>
                    <option value="aprobado">Contratados activos</option>
                    <option value="rechazado">Rechazados</option>
                    <option value="inactivo">Inactivos/Despedidos</option>
                </select>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="botones-navegacion">
            <button class="btn btn-inicio" onclick="cambiarSeccion('inicio')">
                <i class="fas fa-home"></i> Inicio
            </button>
            <button class="btn btn-dashboard" onclick="cambiarSeccion('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="btn btn-guardar" onclick="guardarLocal()">
                <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-sincronizar" onclick="sincronizarNube()">
                <i class="fas fa-cloud-upload-alt"></i> Sincronizar
            </button>
            <button class="btn btn-imprimir" onclick="imprimirReporte()">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <button class="btn btn-salir" onclick="salir()">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </div>

        <!-- Pestañas de secciones -->
        <div class="tabs">
            <div class="tab activa" data-tab="contratacion" onclick="cambiarTab('contratacion')">Contratación</div>
            <div class="tab" data-tab="aplicantes" onclick="cambiarTab('aplicantes')">Aplicantes</div>
            <div class="tab" data-tab="asistencia" onclick="cambiarTab('asistencia')">Control de Asistencia</div>
            <div class="tab" data-tab="planilla" onclick="cambiarTab('planilla')">Planilla y Pagos</div>
            <div class="tab" data-tab="vacaciones" onclick="cambiarTab('vacaciones')">Vacaciones</div>
            <div class="tab" data-tab="ubicacion" onclick="cambiarTab('ubicacion')">Ubicación en Tiempo Real</div>
        </div>

        <!-- SECCIÓN: Contratación -->
        <div id="seccion-contratacion" class="seccion activa">
            <h2 class="seccion-titulo"><i class="fas fa-user-plus"></i> Contratación de Personal</h2>
            
            <!-- Formulario para el administrador -->
            <div class="campo-formulario">
                <label for="nombreProyectoContratacion"><i class="fas fa-hard-hat"></i> Proyecto para Contratación</label>
                <select id="nombreProyectoContratacion">
                    <option value="">-- Seleccionar proyecto --</option>
                </select>
            </div>

            <h3 style="color: var(--amarillo-mostaza); margin: 20px 0 15px 0;">
                <i class="fas fa-clipboard-list"></i> Puestos Disponibles para este Proyecto
            </h3>
            
            <div class="puestos-disponibles">
                <div class="puesto-item puesto-disponible">
                    <span>Supervisor (1 vacante)</span>
                    <span>Q. 250.00/día</span>
                </div>
                <div class="puesto-item puesto-disponible">
                    <span>Encargado de Obra (2 vacantes)</span>
                    <span>Q. 250.00/día</span>
                </div>
                <div class="puesto-item puesto-disponible">
                    <span>Maestro de Obras (3 vacantes)</span>
                    <span>Q. 200.00/día</span>
                </div>
                <div class="puesto-item puesto-no-disponible">
                    <span>Albañil (0 vacantes)</span>
                    <span>Q. 175.00/día</span>
                </div>
                <div class="puesto-item puesto-disponible">
                    <span>Ayudante (5 vacantes)</span>
                    <span>Q. 125.00/día</span>
                </div>
                <div class="puesto-item puesto-disponible">
                    <span>Peón (8 vacantes)</span>
                    <span>Q. 100.00/día</span>
                </div>
            </div>

            <h3 style="color: var(--amarillo-mostaza); margin: 30px 0 15px 0;">
                <i class="fas fa-user-edit"></i> Formulario para Aplicante
            </h3>
            
            <div class="formulario-contratacion">
                <div class="campo-formulario">
                    <label for="nombreCompleto"><i class="fas fa-user"></i> Nombre Completo</label>
                    <input type="text" id="nombreCompleto" placeholder="Ingrese nombre completo">
                </div>
                
                <div class="campo-formulario">
                    <label for="direccion"><i class="fas fa-home"></i> Dirección (Domicilio Actual)</label>
                    <input type="text" id="direccion" placeholder="Ingrese dirección completa">
                </div>
                
                <div class="campo-formulario">
                    <label for="telefono"><i class="fas fa-phone"></i> Teléfono</label>
                    <input type="tel" id="telefono" placeholder="Ingrese número de teléfono">
                </div>
                
                <div class="campo-formulario">
                    <label for="dpi"><i class="fas fa-id-card"></i> DPI / CUI</label>
                    <input type="text" id="dpi" placeholder="Ingrese número de DPI">
                </div>
                
                <div class="campo-formulario">
                    <label for="puesto"><i class="fas fa-briefcase"></i> Puesto a Aplicar</label>
                    <select id="puesto">
                        <option value="">-- Seleccionar puesto --</option>
                        <option value="supervisor">Supervisor (Q. 250.00/día)</option>
                        <option value="encargado">Encargado de Obra (Q. 250.00/día)</option>
                        <option value="maestro">Maestro de Obras (Q. 200.00/día)</option>
                        <option value="albanil" disabled>Albañil (Sin vacantes)</option>
                        <option value="ayudante">Ayudante (Q. 125.00/día)</option>
                        <option value="peon">Peón (Q. 100.00/día)</option>
                    </select>
                </div>
                
                <div class="campo-formulario">
                    <label for="experiencia"><i class="fas fa-chart-line"></i> Años de Experiencia en el Puesto</label>
                    <select id="experiencia">
                        <option value="">-- Seleccione años --</option>
                        <option value="0-1">0-1 años</option>
                        <option value="1-3">1-3 años</option>
                        <option value="3-5">3-5 años</option>
                        <option value="5+">5+ años</option>
                    </select>
                    <small style="color: #aaa; display: block; margin-top: 5px;">
                        Requisitos: Supervisores 4-6 años, Encargados y Albañiles 4-6 años, Ayudantes y Peones 0-1 años
                    </small>
                </div>
                
                <div class="campo-formulario">
                    <label for="referencia1"><i class="fas fa-building"></i> Referencia Laboral 1</label>
                    <input type="text" id="referencia1" placeholder="Empresa y tipo de construcción">
                </div>
                
                <div class="campo-formulario">
                    <label for="referencia2"><i class="fas fa-building"></i> Referencia Laboral 2</label>
                    <input type="text" id="referencia2" placeholder="Empresa y tipo de construcción">
                </div>
                
                <div class="campo-formulario">
                    <label for="tipoConstruccion"><i class="fas fa-drafting-compass"></i> Tipo de Construcción Experiencia</label>
                    <select id="tipoConstruccion">
                        <option value="">-- Seleccionar tipo --</option>
                        <option value="residencial">Residencial</option>
                        <option value="comercial">Comercial</option>
                        <option value="industrial">Industrial</option>
                        <option value="civil">Civil</option>
                        <option value="publica">Pública</option>
                    </select>
                </div>
            </div>

            <!-- Toma de Selfie -->
            <div class="selfie-container">
                <h4 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">
                    <i class="fas fa-camera"></i> Toma de Selfie para Expediente
                </h4>
                
                <video id="videoElement" autoplay></video>
                <img id="selfiePreview" class="selfie-preview" alt="Selfie capturada">
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="iniciarCamara()" class="btn-firma">
                        <i class="fas fa-video"></i> Activar Cámara
                    </button>
                    <button onclick="capturarSelfie()" class="btn-firma" style="background: var(--verde);">
                        <i class="fas fa-camera-retro"></i> Capturar Selfie
                    </button>
                    <button onclick="detenerCamara()" class="btn-firma" style="background: var(--rojo);">
                        <i class="fas fa-stop-circle"></i> Detener Cámara
                    </button>
                </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="aceptacion">
                <h4 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">
                    <i class="fas fa-file-contract"></i> Términos y Condiciones de Contrato
                </h4>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="aceptarHorarios" style="margin-top: 3px;">
                    <label for="aceptarHorarios">
                        <strong>Acepto los horarios establecidos:</strong><br>
                        • Entrada: 7:00 AM<br>
                        • Receso: 9:00 AM a 9:30 AM<br>
                        • Almuerzo: 12:00 PM a 1:00 PM<br>
                        • Salida: 4:00 PM<br>
                        • Horas extras y días festivos según solicitud del supervisor
                    </label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="aceptarResponsabilidades" style="margin-top: 3px;">
                    <label for="aceptarResponsabilidades">
                        <strong>Acepto las responsabilidades del puesto:</strong><br>
                        • Cumplir con los procedimientos de seguridad<br>
                        • Reportar cualquier condición insegura<br>
                        • Mantener herramientas y equipo en buen estado<br>
                        • Respetar las políticas de la empresa
                    </label>
                </div>
            </div>

            <!-- Firma Digital -->
            <div class="firma-container">
                <h4 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">
                    <i class="fas fa-signature"></i> Firma Digital del Aplicante
                </h4>
                
                <div class="canvas-contenedor">
                    <canvas id="canvas" width="800" height="200"></canvas>
                </div>
                
                <div class="controles-firma">
                    <button onclick="limpiarFirma()" class="btn-firma">
                        <i class="fas fa-eraser"></i> Limpiar Firma
                    </button>
                    <button onclick="guardarFirma()" class="btn-firma" style="background: var(--verde);">
                        <i class="fas fa-save"></i> Guardar Firma
                    </button>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="acciones-botones">
                <button type="button" onclick="enviarAplicacion()" class="btn btn-enviar-aplicacion">
                    <i class="fas fa-paper-plane"></i> Enviar Aplicación
                </button>
                <button onclick="generarLinkAplicante()" class="btn" style="background: linear-gradient(90deg, #3498db, #2980b9);">
                    <i class="fas fa-link"></i> Generar Link para Aplicante
                </button>
                <button onclick="limpiarFormulario()" class="btn" style="background: linear-gradient(90deg, #95a5a6, #7f8c8d);">
                    <i class="fas fa-redo"></i> Limpiar Formulario
                </button>
            </div>
        </div>

        <!-- SECCIÓN: Aplicantes -->
        <div id="seccion-aplicantes" class="seccion">
            <h2 class="seccion-titulo"><i class="fas fa-users"></i> Aplicantes y Contratos</h2>
            
            <div class="lista-aplicantes">
                <!-- Los aplicantes aparecerán aquí cuando se agreguen desde la base de datos -->
                <div style="text-align: center; padding: 40px; color: #888;">
                    <i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                    <p>No hay aplicantes registrados. Los aplicantes aparecerán aquí cuando se agreguen al sistema.</p>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="exportarContratosCSV()" class="btn" style="background: linear-gradient(90deg, #16a085, #1abc9c);">
                    <i class="fas fa-file-export"></i> Exportar Contratos a CSV
                </button>
                <button onclick="importarContratosCSV()" class="btn" style="background: linear-gradient(90deg, #8e44ad, #9b59b6);">
                    <i class="fas fa-file-import"></i> Importar Contratos desde CSV
                </button>
            </div>
        </div>

        <!-- SECCIÓN: Control de Asistencia -->
        <div id="seccion-asistencia" class="seccion">
            <h2 class="seccion-titulo"><i class="fas fa-calendar-check"></i> Control de Asistencia</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="campo-formulario">
                    <label for="fechaAsistencia"><i class="fas fa-calendar-alt"></i> Seleccionar Fecha</label>
                    <input type="date" id="fechaAsistencia" value="">
                </div>
                
                <div class="campo-formulario">
                    <label for="proyectoAsistencia"><i class="fas fa-hard-hat"></i> Proyecto</label>
                    <select id="proyectoAsistencia">
                        <option value="todos">Todos los proyectos</option>
                    </select>
                </div>
            </div>

            <div class="filtros" id="asistenciaRegistroPanel">
                <h3 style="color: var(--amarillo-mostaza); margin-bottom: 10px;">
                    <i class="fas fa-location-dot"></i> Registrar asistencia con GPS
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px;">
                    <div class="campo-formulario">
                        <label for="asistenciaTrabajador"><i class="fas fa-user"></i> Trabajador</label>
                        <select id="asistenciaTrabajador"></select>
                    </div>
                    <div class="campo-formulario">
                        <label for="asistenciaTipo"><i class="fas fa-clock"></i> Tipo</label>
                        <select id="asistenciaTipo">
                            <option value="entrada">Entrada</option>
                            <option value="salida">Salida</option>
                        </select>
                    </div>
                    <div class="campo-formulario">
                        <label for="asistenciaObs"><i class="fas fa-note-sticky"></i> Observaciones (opcional)</label>
                        <input id="asistenciaObs" type="text" placeholder="Ej: Llegó tarde por tráfico">
                    </div>
                </div>

                <div class="rrhh-map-controls">
                    <button onclick="registrarAsistenciaConGPS()" class="btn btn-guardar">
                        <i class="fas fa-check"></i> Registrar con GPS
                    </button>
                    <button onclick="refrescarAsistencias()" class="btn btn-sincronizar">
                        <i class="fas fa-rotate"></i> Refrescar
                    </button>
                </div>
                <div id="asistenciaGpsStatus" class="rrhh-muted" style="margin-top: 8px;"></div>
            </div>
            
            <h3 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">Asistencias del Día</h3>
            
            <table class="tabla-planilla">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Puesto</th>
                        <th>Hora Entrada</th>
                        <th>Hora Salida</th>
                        <th>Horas Trabajadas</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="asistenciasBody"></tbody>
            </table>
            
            <h3 style="color: var(--amarillo-mostaza); margin: 30px 0 15px 0;">Alertas de Asistencia</h3>
            
            <div style="background: rgba(231, 76, 60, 0.2); padding: 15px; border-radius: 8px; border-left: 4px solid var(--rojo);">
                <h4><i class="fas fa-exclamation-triangle"></i> Alertas Activas</h4>
                <ul style="margin-top: 10px;">
                    <li><span style="opacity: 0.9;">Sin alertas activas por ahora.</span></li>
                </ul>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="generarReporteAsistencia()" class="btn" style="background: linear-gradient(90deg, #34495e, #2c3e50);">
                    <i class="fas fa-file-pdf"></i> Generar Reporte de Asistencia
                </button>
            </div>
        </div>

        <!-- SECCIÓN: Planilla y Pagos -->
        <div id="seccion-planilla" class="seccion">
            <h2 class="seccion-titulo"><i class="fas fa-money-bill-wave"></i> Planilla y Pagos Semanales</h2>
            
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px;">
                <div>
                    <label for="semanaPlanilla"><i class="fas fa-calendar-week"></i> Semana a Calcular</label>
                    <input type="week" id="semanaPlanilla">
                </div>
                
                <div>
                    <label for="proyectoPlanilla"><i class="fas fa-project-diagram"></i> Proyecto</label>
                    <select id="proyectoPlanilla">
                        <option value="todos">Todos los proyectos</option>
                    </select>
                </div>
            </div>
            
            <h3 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">Cálculo de Planilla Semanal</h3>

            <p class="rrhh-muted" style="margin: 0 0 10px 0;">
                Horario: L-V 07:00–17:00 (almuerzo 12:00–13:00) | Sábado 07:00–12:00 (se paga como día normal)
            </p>
            
            <table class="tabla-planilla">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Puesto</th>
                        <th>Días Trabajados</th>
                        <th>Horas Totales</th>
                        <th>Pago Diario</th>
                        <th>Pago Semanal</th>
                        <th>Deducciones</th>
                        <th>Neto a Pagar</th>
                    </tr>
                </thead>
                <tbody id="planillaBody"></tbody>
                <tfoot>
                    <tr id="planillaTotalsRow" style="background: rgba(255, 215, 0, 0.1); font-weight: bold;">
                        <td colspan="5"><strong>TOTAL PLANILLA</strong></td>
                        <td id="planillaTotalBruto"><strong>Q. 0.00</strong></td>
                        <td id="planillaTotalDeducciones"><strong>Q. 0.00</strong></td>
                        <td id="planillaTotalNeto"><strong style="color: var(--verde);">Q. 0.00</strong></td>
                    </tr>
                </tfoot>
            </table>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="calcularPlanilla()" class="btn" style="background: linear-gradient(90deg, #27ae60, #219653);">
                    <i class="fas fa-calculator"></i> Calcular Planilla
                </button>
                <button onclick="generarPagos()" class="btn" style="background: linear-gradient(90deg, #e67e22, #d35400);">
                    <i class="fas fa-money-check-alt"></i> Generar Ordenes de Pago
                </button>
                <button onclick="exportarPlanillaPDF()" class="btn" style="background: linear-gradient(90deg, #34495e, #2c3e50);">
                    <i class="fas fa-file-pdf"></i> Exportar Planilla a PDF
                </button>
            </div>
        </div>

        <!-- SECCIÓN: Vacaciones -->
        <div id="seccion-vacaciones" class="seccion">
            <h2 class="seccion-titulo"><i class="fas fa-umbrella-beach"></i> Solicitudes de Vacaciones</h2>

            <div class="formulario-contratacion">
                <div class="campo-formulario">
                    <label for="vacTrabajador"><i class="fas fa-user"></i> Trabajador</label>
                    <select id="vacTrabajador"></select>
                </div>

                <div class="campo-formulario">
                    <label for="vacNombreManual"><i class="fas fa-pen"></i> Nombre (si no aparece)</label>
                    <input type="text" id="vacNombreManual" placeholder="Nombre del trabajador">
                </div>

                <div class="campo-formulario">
                    <label for="vacInicio"><i class="fas fa-calendar-alt"></i> Fecha Inicio</label>
                    <input type="date" id="vacInicio">
                </div>

                <div class="campo-formulario">
                    <label for="vacFin"><i class="fas fa-calendar-check"></i> Fecha Fin</label>
                    <input type="date" id="vacFin">
                </div>

                <div class="campo-formulario" style="grid-column: 1 / -1;">
                    <label for="vacMotivo"><i class="fas fa-comment"></i> Motivo / Observaciones</label>
                    <textarea id="vacMotivo" placeholder="Detalle de la solicitud"></textarea>
                </div>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="crearSolicitudVacaciones()" class="btn" style="background: linear-gradient(90deg, #27ae60, #219653);">
                    <i class="fas fa-paper-plane"></i> Enviar Solicitud
                </button>
                <button onclick="limpiarFormularioVacaciones()" class="btn" style="background: linear-gradient(90deg, #95a5a6, #7f8c8d);">
                    <i class="fas fa-redo"></i> Limpiar
                </button>
            </div>

            <h3 style="color: var(--amarillo-mostaza); margin: 30px 0 15px 0;">
                <i class="fas fa-list"></i> Solicitudes Registradas
            </h3>

            <table class="tabla-planilla">
                <thead>
                    <tr>
                        <th>Trabajador</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Días</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="vacacionesBody"></tbody>
            </table>
        </div>

        <!-- SECCIÓN: Ubicación en Tiempo Real -->
        <div id="seccion-ubicacion" class="seccion">
            <h2 class="seccion-titulo"><i class="fas fa-map-marked-alt"></i> Ubicación de Trabajadores en Tiempo Real</h2>
            
            <div class="mapa-container">
                <div class="mapa-placeholder" id="mapaPlaceholder">
                    <div id="rrhhMapCanvas" class="rrhh-map-canvas"></div>
                    <div id="rrhhMapOverlay" class="rrhh-map-overlay">
                        Abre esta sección para cargar el mapa y ver ubicaciones.
                    </div>
                </div>
            </div>

            <div class="rrhh-map-controls">
                <button onclick="RRHHMapActions.cargar()" class="btn-firma" style="background: #3498db;">
                    <i class="fas fa-map"></i> Cargar mapa
                </button>
                <button onclick="RRHHMapActions.configurarKey()" class="btn-firma">
                    <i class="fas fa-key"></i> Configurar API Key
                </button>
                <button onclick="RRHHMapActions.refrescar()" class="btn-firma" style="background: #2ecc71;">
                    <i class="fas fa-rotate"></i> Refrescar ubicaciones
                </button>
                <button onclick="RRHHMapActions.centrar()" class="btn-firma" style="background: #f39c12;">
                    <i class="fas fa-crosshairs"></i> Centrar
                </button>
            </div>
            
            <div style="margin-top: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <h4 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">
                        <i class="fas fa-user-check"></i> Trabajadores en Sitio
                    </h4>
                    <div id="workersOnSite" style="background: rgba(46, 204, 113, 0.2); padding: 15px; border-radius: 8px;"></div>
                </div>
                
                <div>
                    <h4 style="color: var(--amarillo-mostaza); margin-bottom: 15px;">
                        <i class="fas fa-user-times"></i> Trabajadores Fuera de Sitio
                    </h4>
                    <div id="workersOffSite" style="background: rgba(231, 76, 60, 0.2); padding: 15px; border-radius: 8px;"></div>
                </div>
            </div>
            
            <h4 style="color: var(--amarillo-mostaza); margin: 25px 0 15px 0;">
                <i class="fas fa-comments"></i> Comunicación con Trabajadores
            </h4>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button onclick="abrirChatGeneral()" class="btn-firma" style="background: #3498db;">
                    <i class="fas fa-comment-dots"></i> Chat General
                </button>
                <button onclick="llamarSupervisor()" class="btn-firma" style="background: #2ecc71;">
                    <i class="fas fa-phone-alt"></i> Llamar a Supervisor
                </button>
                <button onclick="enviarAlertaGeneral()" class="btn-firma" style="background: #f39c12;">
                    <i class="fas fa-bell"></i> Enviar Alerta General
                </button>
            </div>
        </div>
    </div>

    <!-- Selector de contacto (RRHH) -->
    <div id="contactPickerOverlay" class="modal-overlay" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="contactPickerTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="contactPickerTitle">Seleccionar contacto</h3>
                <button class="modal-close" type="button" onclick="ContactPicker.close()" aria-label="Cerrar">×</button>
            </div>
            <div class="modal-body">
                <input id="contactPickerSearch" class="form-control contact-picker-search" type="text" placeholder="Buscar por nombre, puesto o teléfono">
                <div id="contactPickerList" class="contact-picker-list"></div>

                <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid rgba(212,175,55,0.2);">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label class="form-label" for="contactPickerManualName">Nombre (opcional)</label>
                        <input id="contactPickerManualName" class="form-control" type="text" placeholder="Ej: Juan Pérez">
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label class="form-label" for="contactPickerManualPhone">Teléfono</label>
                        <input id="contactPickerManualPhone" class="form-control" type="tel" placeholder="Ej: 55554444 o +50255554444">
                    </div>
                    <div style="display:flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button type="button" class="btn-firma" onclick="ContactPicker.useManual()">
                            <i class="fas fa-check"></i> Usar número
                        </button>
                        <button type="button" class="btn-firma" onclick="ContactPicker.close()">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            </div>

            <div id="contactPickerFooter" class="modal-footer" style="display:none; justify-content: space-between; align-items: center;">
                <div id="contactPickerFooterHint" style="opacity: 0.9;"></div>
                <div style="display:flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                    <button type="button" class="btn-firma" onclick="ContactPicker.clearSelection()">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                    <button id="contactPickerConfirmBtn" type="button" class="btn-firma" onclick="ContactPicker.confirm()">
                        <i class="fas fa-paper-plane"></i> Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaciones -->
    <div class="notificaciones" id="notificaciones"></div>

    <script>
        // Variables globales
        let aplicantes = [];
        let trabajadoresActivos = [];
        let solicitudesVacaciones = [];
        let intervaloReloj;
        let streamCamara = null;
        let simulacionUbicacion = null;

        // Google Maps API Key
        // Nota: no se recomienda dejar la key hardcodeada en el HTML.
        // Aquí la leemos desde localStorage para que puedas configurarla sin exponerla en el repo.
        const GOOGLE_MAPS_API_KEY_STORAGE_KEY = 'rrhh_google_maps_api_key_v1';

        function getGoogleMapsApiKey() {
            try {
                const meta = document.querySelector('meta[name="google-maps-api-key"]')?.getAttribute('content');
                const stored = localStorage.getItem(GOOGLE_MAPS_API_KEY_STORAGE_KEY);
                return String(meta || stored || '').trim();
            } catch {
                return '';
            }
        }

        function setGoogleMapsApiKey(key) {
            const safe = String(key || '').trim();
            if (!safe) return false;
            try {
                localStorage.setItem(GOOGLE_MAPS_API_KEY_STORAGE_KEY, safe);
                return true;
            } catch {
                return false;
            }
        }

        // Horario laboral
        // Lunes a Viernes: 07:00 - 17:00 con almuerzo 12:00 - 13:00
        // Sábado: medio día (07:00 - 12:00). El almuerzo solo aplica si el turno cruza 12:00.
        const WORK_SCHEDULE = {
            startHour: 7,
            endHourWeekday: 17,
            endHourSaturday: 12,
            lunchStartHour: 12,
            lunchEndHour: 13,
            graceMinutesLate: 10 // tolerancia para retardo
        };

        const RRHH_RUNTIME = {
            mapsPromise: null,
            map: null,
            markers: new Map(),
            infoWindow: null,
            refreshTimer: null
        };

        window.RRHHMapActions = {
            cargar: () => initUbicacionTab(true),
            refrescar: () => updateWorkerMap(true),
            centrar: () => centerWorkerMap(),
            configurarKey: () => {
                const current = getGoogleMapsApiKey();
                const entered = prompt('Pega tu Google Maps API Key (se guardará solo en este navegador):', current || '');
                if (!entered) return;
                if (!setGoogleMapsApiKey(entered)) {
                    alert('No se pudo guardar la key en este navegador.');
                    return;
                }

                // Forzar recarga del script
                try {
                    document.querySelector('script[data-rrhh-gmaps="1"]')?.remove();
                } catch {}
                RRHH_RUNTIME.mapsPromise = null;
                RRHH_RUNTIME.map = null;
                RRHH_RUNTIME.markers?.forEach?.(m => { try { m.setMap(null); } catch {} });
                RRHH_RUNTIME.markers = new Map();

                initUbicacionTab(true);
            }
        };

        // Google llama a gm_authFailure cuando hay problema de autenticación/permiso con la key.
        window.gm_authFailure = function () {
            const overlay = document.getElementById('rrhhMapOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
                overlay.innerHTML = `
                    <div>
                        <div style="margin-bottom:10px;">No se pudo autenticar Google Maps.</div>
                        <div class="rrhh-muted" style="margin-bottom:12px;">Revisa que la API "Maps JavaScript API" esté habilitada y que la key tenga restricciones correctas (HTTP referrers / dominios).</div>
                        <button class="btn-firma" style="background:#3498db;" onclick="RRHHMapActions.configurarKey()">Configurar API Key</button>
                    </div>
                `;
            }
            try { document.querySelector('script[data-rrhh-gmaps="1"]')?.remove(); } catch {}
            RRHH_RUNTIME.mapsPromise = null;
        };

        // Inicializar cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', function() {
            iniciarReloj();
            initApplicantSignature();
            cargarDatosLocales();
            actualizarFechaAsistencia();
            inicializarTabDesdeHash();
            refrescarVacacionesUI();
            initAsistenciaUI();
            refrescarAsistencias();
            initContactPickerUI();

            const weekInput = document.getElementById('semanaPlanilla');
            if (weekInput && !weekInput.value) {
                weekInput.value = getISOWeekString(new Date());
            }
        });

        function getDB() {
            return (window.AdvancedDB && typeof window.AdvancedDB.get === 'function') ? window.AdvancedDB : null;
        }

        function formatTimeOrDash(iso) {
            if (!iso) return '--';
            try {
                return new Date(iso).toLocaleTimeString('es-GT', { hour: '2-digit', minute: '2-digit' });
            } catch {
                return '--';
            }
        }

        function parseLocalDateYMD(ymd) {
            // ymd: YYYY-MM-DD
            if (!ymd || typeof ymd !== 'string') return null;
            const [y, m, d] = ymd.split('-').map(n => Number(n));
            if (!y || !m || !d) return null;
            return new Date(y, m - 1, d, 0, 0, 0, 0);
        }

        function getWorkWindowsForDate(ymd) {
            const base = parseLocalDateYMD(ymd);
            if (!base) return [];
            const day = base.getDay(); // 0 Dom ... 6 Sáb
            if (day === 0) return []; // Domingo no laboral

            const mk = (h, min = 0) => {
                const dt = new Date(base);
                dt.setHours(h, min, 0, 0);
                return dt.getTime();
            };

            if (day === 6) {
                // Sábado medio día
                return [[mk(WORK_SCHEDULE.startHour), mk(WORK_SCHEDULE.endHourSaturday)]];
            }

            // Lunes a viernes: 07:00-12:00 y 13:00-17:00
            return [
                [mk(WORK_SCHEDULE.startHour), mk(WORK_SCHEDULE.lunchStartHour)],
                [mk(WORK_SCHEDULE.lunchEndHour), mk(WORK_SCHEDULE.endHourWeekday)]
            ];
        }

        function isWorkday(ymd) {
            const base = parseLocalDateYMD(ymd);
            if (!base) return false;
            const day = base.getDay();
            return day >= 1 && day <= 6;
        }

        function isWithinBusinessHours(dateObj = new Date()) {
            const ymd = dateObj.toISOString().slice(0, 10);
            const windows = getWorkWindowsForDate(ymd);
            const t = dateObj.getTime();
            return windows.some(([a, b]) => t >= a && t <= b);
        }

        function computeWorkedHours(entradaIso, salidaIso, ymd) {
            if (!entradaIso || !salidaIso) return 0;
            const a = new Date(entradaIso).getTime();
            const b = new Date(salidaIso).getTime();
            if (!Number.isFinite(a) || !Number.isFinite(b) || b <= a) return 0;

            const windows = getWorkWindowsForDate(ymd);
            if (!windows.length) return 0;

            let ms = 0;
            for (const [wa, wb] of windows) {
                const start = Math.max(a, wa);
                const end = Math.min(b, wb);
                if (end > start) ms += (end - start);
            }
            return ms / 3600000;
        }

        function computeWorkedMs(entradaIso, salidaIso, ymd) {
            if (!entradaIso || !salidaIso) return 0;
            const a = new Date(entradaIso).getTime();
            const b = new Date(salidaIso).getTime();
            if (!Number.isFinite(a) || !Number.isFinite(b) || b <= a) return 0;

            const windows = getWorkWindowsForDate(ymd);
            if (!windows.length) return 0;

            let ms = 0;
            for (const [wa, wb] of windows) {
                const start = Math.max(a, wa);
                const end = Math.min(b, wb);
                if (end > start) ms += (end - start);
            }
            return ms;
        }

        function getScheduledMsForDate(ymd) {
            const windows = getWorkWindowsForDate(ymd);
            return windows.reduce((acc, [a, b]) => acc + Math.max(0, (b - a)), 0);
        }

        function getShiftStartMs(ymd) {
            const base = parseLocalDateYMD(ymd);
            if (!base) return null;
            base.setHours(WORK_SCHEDULE.startHour, 0, 0, 0);
            return base.getTime();
        }

        function getActiveWorkers() {
            const db = getDB();
            if (db) {
                try {
                    const list = db.get('trabajadores') || [];
                    return list
                        .filter(t => (t && (t.estado || 'activo') === 'activo'))
                        .map(t => ({
                            id: String(t.id),
                            nombre: `${t.nombre || ''} ${t.apellido || ''}`.trim() || t.nombre || 'Sin nombre',
                            puesto: t.puesto || '—',
                            salarioDiario: Number(t.salarioDiario) || 0
                        }));
                } catch {}
            }

            // Fallback (datos locales RRHH)
            return (trabajadoresActivos || []).map(t => ({
                id: String(t.idTrabajador || t.id || t.codigo || Date.now()),
                nombre: t.nombreCompleto || t.nombre || t.nombres || 'Sin nombre',
                puesto: t.puesto || '—',
                salarioDiario: Number(t.salarioDiario) || 0
            }));
        }

        function getProjects() {
            const db = getDB();
            if (db) {
                try {
                    const list = db.get('proyectos') || [];
                    return list.map(p => ({ id: String(p.id), nombre: p.nombre || p.codigo || 'Proyecto' }));
                } catch {}
            }
            return [];
        }

        function initAsistenciaUI() {
            const workers = getActiveWorkers();
            const workerSelect = document.getElementById('asistenciaTrabajador');
            if (workerSelect) {
                workerSelect.innerHTML = workers.length
                    ? workers.map(w => `<option value="${w.id}">${w.nombre} (${w.puesto})</option>`).join('')
                    : `<option value="">(Sin trabajadores registrados)</option>`;
            }

            // Poblar proyectos en el select existente si hay datos reales
            const projectSelect = document.getElementById('proyectoAsistencia');
            const projectPlanilla = document.getElementById('proyectoPlanilla');
            const projectFilter = document.getElementById('filtroProyecto');
            const projectContratacion = document.getElementById('nombreProyectoContratacion');
            const projects = getProjects();
            if (projectSelect && projects.length) {
                projectSelect.innerHTML = `
                    <option value="todos">Todos los proyectos</option>
                    ${projects.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                `;
            }

            if (projectPlanilla && projects.length) {
                projectPlanilla.innerHTML = `
                    <option value="todos">Todos los proyectos</option>
                    ${projects.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                `;
            }

            if (projectFilter) {
                projectFilter.innerHTML = projects.length
                    ? `
                        <option value="">-- Seleccionar proyecto --</option>
                        ${projects.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                    `
                    : `<option value="" selected>(Sin proyectos registrados)</option>`;
            }

            if (projectContratacion) {
                projectContratacion.innerHTML = projects.length
                    ? `
                        <option value="">-- Seleccionar proyecto --</option>
                        ${projects.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                    `
                    : `<option value="" selected>(Sin proyectos registrados)</option>`;
            }

            // Al cambiar filtros, refrescar tabla
            document.getElementById('fechaAsistencia')?.addEventListener('change', refrescarAsistencias);
            document.getElementById('proyectoAsistencia')?.addEventListener('change', refrescarAsistencias);

            document.getElementById('semanaPlanilla')?.addEventListener('change', calcularPlanilla);
            document.getElementById('proyectoPlanilla')?.addEventListener('change', calcularPlanilla);
        }

        function scheduleLabelForDate(ymd) {
            const base = parseLocalDateYMD(ymd);
            if (!base) return 'Horario no definido';
            const day = base.getDay();
            if (day === 0) return 'Domingo (no laboral)';
            if (day === 6) return 'Sábado 07:00–12:00 (sin almuerzo)';
            return 'Lunes a Viernes 07:00–17:00 (almuerzo 12:00–13:00)';
        }

        function getShiftEndMs(ymd) {
            const base = parseLocalDateYMD(ymd);
            if (!base) return null;
            const day = base.getDay();
            if (day === 6) {
                base.setHours(WORK_SCHEDULE.endHourSaturday, 0, 0, 0);
                return base.getTime();
            }
            base.setHours(WORK_SCHEDULE.endHourWeekday, 0, 0, 0);
            return base.getTime();
        }

        function computeWorkedHoursFromRecord(asistencia, ymd) {
            if (!asistencia) return 0;

            let entradaIso = asistencia.horaEntrada || null;
            let salidaIso = asistencia.horaSalida || null;

            const startMs = getShiftStartMs(ymd);
            const endMs = getShiftEndMs(ymd);

            // Si falta entrada/salida, estimar usando límites del turno
            if (!entradaIso && salidaIso && startMs != null) {
                entradaIso = new Date(startMs).toISOString();
            }
            if (entradaIso && !salidaIso && endMs != null) {
                salidaIso = new Date(endMs).toISOString();
            }

            return computeWorkedHours(entradaIso, salidaIso, ymd);
        }

        function computeWorkedMsFromRecord(asistencia, ymd) {
            if (!asistencia) return 0;

            let entradaIso = asistencia.horaEntrada || null;
            let salidaIso = asistencia.horaSalida || null;

            const startMs = getShiftStartMs(ymd);
            const endMs = getShiftEndMs(ymd);

            if (!entradaIso && salidaIso && startMs != null) {
                entradaIso = new Date(startMs).toISOString();
            }
            if (entradaIso && !salidaIso && endMs != null) {
                salidaIso = new Date(endMs).toISOString();
            }

            return computeWorkedMs(entradaIso, salidaIso, ymd);
        }

        function roundMoney(value) {
            const n = Number(value);
            if (!Number.isFinite(n)) return 0;
            return Math.round((n + Number.EPSILON) * 100) / 100;
        }

        function toMoneyGTQ(value) {
            const n = Number(value);
            const safe = Number.isFinite(n) ? n : 0;
            return new Intl.NumberFormat('es-GT', { style: 'currency', currency: 'GTQ' }).format(safe);
        }

        function getMondayOfISOWeek(isoWeek) {
            const m = String(isoWeek || '').match(/^(\d{4})-W(\d{2})$/);
            if (!m) return null;
            const year = Number(m[1]);
            const week = Number(m[2]);
            if (!Number.isFinite(year) || !Number.isFinite(week) || week < 1 || week > 53) return null;

            const jan4 = new Date(year, 0, 4);
            const day = jan4.getDay() || 7; // 1..7 (Lun..Dom)
            const monday = new Date(jan4);
            monday.setDate(jan4.getDate() - (day - 1) + (week - 1) * 7);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function formatYMDLocal(dateObj) {
            const y = dateObj.getFullYear();
            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
            const d = String(dateObj.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getISOWeekString(dateObj = new Date()) {
            // Devuelve YYYY-Www para input type="week"
            const d = new Date(dateObj);
            d.setHours(0, 0, 0, 0);
            // Jueves determina el año ISO
            const day = (d.getDay() || 7);
            d.setDate(d.getDate() + 4 - day);
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function refrescarAsistencias() {
            const tbody = document.getElementById('asistenciasBody');
            if (!tbody) return;
            const db = getDB();

            const fecha = document.getElementById('fechaAsistencia')?.value || new Date().toISOString().split('T')[0];
            const proyectoFiltro = document.getElementById('proyectoAsistencia')?.value || 'todos';
            const workers = getActiveWorkers();

            let asistencias = [];
            if (db) {
                try {
                    asistencias = (db.get('asistencias') || []).filter(a => a && a.fecha === fecha);
                    if (proyectoFiltro !== 'todos') {
                        asistencias = asistencias.filter(a => String(a.proyectoId) === String(proyectoFiltro));
                    }
                } catch {
                    asistencias = [];
                }
            }

            const asistenciaByWorker = new Map();
            asistencias.forEach(a => {
                if (!a || !a.trabajadorId) return;
                asistenciaByWorker.set(String(a.trabajadorId), a);
            });

            const statusDot = (color) => `<span style="color: ${color};">●</span>`;

            tbody.innerHTML = workers.map(w => {
                const a = asistenciaByWorker.get(String(w.id));
                const entrada = a?.horaEntrada || null;
                const salida = a?.horaSalida || null;
                const horas = computeWorkedHours(entrada, salida, fecha);

                const laboral = isWorkday(fecha);

                // Estado simple: presente/tardanza/ausente
                let estadoTexto = laboral ? 'Ausente' : 'No laboral';
                let estadoColor = laboral ? 'var(--rojo)' : '#95a5a6';
                if (entrada) {
                    estadoTexto = 'Puntual';
                    estadoColor = 'var(--verde)';
                    try {
                        const entradaDate = new Date(entrada);
                        const startMs = getShiftStartMs(fecha);
                        const limite = (startMs != null)
                            ? (startMs + WORK_SCHEDULE.graceMinutesLate * 60000)
                            : new Date(`${fecha}T07:10:00`).getTime();
                        if (entradaDate.getTime() > limite) {
                            estadoTexto = 'Retardo';
                            estadoColor = '#f39c12';
                        }
                    } catch {}
                }

                const gpsFlag = (a?.ubicacionEntrada || a?.ubicacionSalida) ? `<small style="opacity:0.85;">GPS ✓</small>` : `<small style="opacity:0.65;">GPS —</small>`;

                return `
                    <tr>
                        <td>${w.nombre}<br>${gpsFlag}</td>
                        <td>${w.puesto}</td>
                        <td>${formatTimeOrDash(entrada)}</td>
                        <td>${formatTimeOrDash(salida)}</td>
                        <td>${horas > 0 ? `${horas.toFixed(2)} horas` : '--'}</td>
                        <td>${statusDot(estadoColor)} ${estadoTexto}</td>
                    </tr>
                `;
            }).join('');
        }

        function getCurrentPosition(options) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalización no disponible en este dispositivo'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, options);
            });
        }

        async function registrarAsistenciaConGPS() {
            const statusEl = document.getElementById('asistenciaGpsStatus');
            const db = getDB();
            if (!db) {
                if (statusEl) statusEl.textContent = 'Base de datos no disponible (database.js).';
                mostrarNotificacion('No se pudo registrar: BD no disponible', 'error');
                return;
            }

            const trabajadorId = document.getElementById('asistenciaTrabajador')?.value || '';
            const tipo = document.getElementById('asistenciaTipo')?.value || 'entrada';
            const fecha = document.getElementById('fechaAsistencia')?.value || new Date().toISOString().split('T')[0];
            const proyectoIdRaw = document.getElementById('proyectoAsistencia')?.value || 'general';
            const proyectoId = (proyectoIdRaw === 'todos' ? 'general' : proyectoIdRaw);
            const observaciones = (document.getElementById('asistenciaObs')?.value || '').trim();

            if (!trabajadorId) {
                mostrarNotificacion('Seleccione un trabajador', 'error');
                return;
            }

            // Control de horario
            const nowLocal = new Date();
            const hoy = nowLocal.toISOString().slice(0, 10);
            if (String(fecha) === String(hoy)) {
                const laboral = isWorkday(fecha);
                const dentro = isWithinBusinessHours(nowLocal);
                if (!laboral) {
                    const ok = confirm('Hoy no es día laboral según el horario (domingo). ¿Registrar de todos modos?');
                    if (!ok) return;
                } else if (!dentro) {
                    const ok = confirm(`Está fuera del horario laboral (${scheduleLabelForDate(fecha)}). ¿Registrar de todos modos?`);
                    if (!ok) return;
                }
            }

            const nowIso = new Date().toISOString();
            if (statusEl) statusEl.textContent = 'Solicitando GPS…';

            let loc = null;
            try {
                const pos = await getCurrentPosition({ enableHighAccuracy: true, timeout: 12000, maximumAge: 0 });
                loc = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    accuracy: pos.coords.accuracy,
                    at: nowIso
                };
            } catch (e) {
                loc = null;
                if (statusEl) statusEl.textContent = `GPS no disponible (${e?.message || 'permiso denegado'}) — se guardará sin ubicación.`;
            }

            // Buscar registro del día
            const all = db.get('asistencias') || [];
            const existing = all.find(a => a && String(a.trabajadorId) === String(trabajadorId) && String(a.proyectoId) === String(proyectoId) && String(a.fecha) === String(fecha));

            const patch = {
                trabajadorId: String(trabajadorId),
                proyectoId: String(proyectoId),
                fecha,
                observaciones: observaciones || (existing?.observaciones || '')
            };

            if (tipo === 'entrada') {
                patch.horaEntrada = nowIso;
                if (loc) patch.ubicacionEntrada = loc;
            } else {
                patch.horaSalida = nowIso;
                if (loc) patch.ubicacionSalida = loc;
            }

            // Calcular horas si hay entrada y salida
            const entradaIso = (tipo === 'entrada' ? nowIso : existing?.horaEntrada) || null;
            const salidaIso = (tipo === 'salida' ? nowIso : existing?.horaSalida) || null;
            const horas = computeWorkedHours(entradaIso, salidaIso, fecha);
            if (horas > 0) patch.horasTrabajadas = horas;

            // Estado simple
            patch.estado = entradaIso ? 'presente' : 'ausente';

            let saved = null;
            if (existing && existing.id) {
                saved = db.update('asistencias', existing.id, { ...existing, ...patch, updatedAt: nowIso });
            } else {
                saved = db.insert('asistencias', { ...patch, createdAt: nowIso });
            }

            if (saved) {
                mostrarNotificacion('Asistencia registrada', 'exito');
                if (statusEl) {
                    statusEl.textContent = loc
                        ? `GPS guardado: ${loc.lat.toFixed(6)}, ${loc.lng.toFixed(6)} (±${Math.round(loc.accuracy)}m)`
                        : 'Registro guardado sin GPS.';
                }
                try { window.SyncService?.syncNow?.(); } catch {}
                refrescarAsistencias();
                updateWorkerMap(true);
            }
        }

        function scheduleMapAutoRefresh() {
            const shouldRun = isWithinBusinessHours(new Date());
            if (shouldRun && !RRHH_RUNTIME.refreshTimer) {
                RRHH_RUNTIME.refreshTimer = setInterval(() => {
                    if (isWithinBusinessHours(new Date())) updateWorkerMap(false);
                }, 30000);
            }
            if (!shouldRun && RRHH_RUNTIME.refreshTimer) {
                clearInterval(RRHH_RUNTIME.refreshTimer);
                RRHH_RUNTIME.refreshTimer = null;
            }
        }

        function ensureGoogleMapsLoaded() {
            if (window.google && window.google.maps) return Promise.resolve();
            if (RRHH_RUNTIME.mapsPromise) return RRHH_RUNTIME.mapsPromise;

            RRHH_RUNTIME.mapsPromise = new Promise((resolve, reject) => {
                if (window.location && window.location.protocol === 'file:') {
                    reject(new Error('Google Maps requiere abrir la app por http:// (por ejemplo localhost). No funciona correctamente con file://'));
                    return;
                }

                const key = getGoogleMapsApiKey();
                if (!key) {
                    reject(new Error('Falta Google Maps API key (usa el botón "Cargar mapa" y configura la key)'));
                    return;
                }

                const existing = document.querySelector('script[data-rrhh-gmaps="1"]');
                if (existing) {
                    existing.addEventListener('load', () => resolve());
                    existing.addEventListener('error', () => reject(new Error('No se pudo cargar Google Maps')));
                    return;
                }

                const script = document.createElement('script');
                // Importante: la key se pasa con el parámetro key=API_KEY
                script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&v=weekly`;
                script.async = true;
                script.defer = true;
                script.dataset.rrhhGmaps = '1';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('No se pudo cargar Google Maps'));
                document.head.appendChild(script);
            });

            return RRHH_RUNTIME.mapsPromise;
        }

        async function initUbicacionTab(forceLoad = false) {
            const overlay = document.getElementById('rrhhMapOverlay');
            if (!forceLoad && RRHH_RUNTIME.map) {
                updateWorkerMap(true);
                scheduleMapAutoRefresh();
                return;
            }

            try {
                if (overlay) {
                    overlay.style.display = 'flex';
                    overlay.textContent = 'Cargando Google Maps…';
                }
                await ensureGoogleMapsLoaded();

                const canvas = document.getElementById('rrhhMapCanvas');
                if (!canvas) return;

                if (!RRHH_RUNTIME.map) {
                    RRHH_RUNTIME.infoWindow = new google.maps.InfoWindow();
                    RRHH_RUNTIME.map = new google.maps.Map(canvas, {
                        center: { lat: 14.6349, lng: -90.5069 },
                        zoom: 11,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: true
                    });
                }

                if (overlay) overlay.style.display = 'none';

                updateWorkerMap(true);

                scheduleMapAutoRefresh();
            } catch (e) {
                if (overlay) {
                    overlay.style.display = 'flex';
                    const msg = (e?.message || String(e));
                    overlay.innerHTML = `
                        <div>
                            <div style="margin-bottom:10px;">No se pudo cargar el mapa: ${msg}</div>
                            <button class="btn-firma" style="background:#3498db;" onclick="RRHHMapActions.configurarKey()">Configurar API Key</button>
                        </div>
                    `;
                }
            }
        }

        function centerWorkerMap() {
            if (!RRHH_RUNTIME.map) return;
            RRHH_RUNTIME.map.setCenter({ lat: 14.6349, lng: -90.5069 });
            RRHH_RUNTIME.map.setZoom(11);
        }

        function getLatestLocationForWorker(workerId) {
            const db = getDB();
            if (!db) return null;
            const all = db.get('asistencias') || [];
            let best = null;

            for (const a of all) {
                if (!a || String(a.trabajadorId) !== String(workerId)) continue;

                const candidates = [
                    { loc: a.ubicacionEntrada, at: a.ubicacionEntrada?.at || a.horaEntrada },
                    { loc: a.ubicacionSalida, at: a.ubicacionSalida?.at || a.horaSalida }
                ].filter(x => x.loc && Number.isFinite(x.loc.lat) && Number.isFinite(x.loc.lng) && x.at);

                for (const c of candidates) {
                    const t = new Date(c.at).getTime();
                    if (!Number.isFinite(t)) continue;
                    if (!best || t > best.atMs) {
                        best = {
                            lat: c.loc.lat,
                            lng: c.loc.lng,
                            accuracy: c.loc.accuracy,
                            atMs: t,
                            atIso: c.at
                        };
                    }
                }
            }

            return best;
        }

        function updateWorkerMap(forceFitBounds = false) {
            const map = RRHH_RUNTIME.map;
            if (!map) return;

            const workers = getActiveWorkers();
            const onSiteEl = document.getElementById('workersOnSite');
            const offSiteEl = document.getElementById('workersOffSite');

            const now = Date.now();
            const inHoursNow = isWithinBusinessHours(new Date());
            const onSite = [];
            const offSite = [];

            const bounds = new google.maps.LatLngBounds();
            let hasBounds = false;

            const seen = new Set();

            workers.forEach(w => {
                const latest = getLatestLocationForWorker(w.id);
                if (!latest) {
                    offSite.push({ worker: w, latest: null });
                    return;
                }

                const ageMin = Math.round((now - latest.atMs) / 60000);
                const isOnSite = inHoursNow && ageMin <= 30; // en sitio si está en horario y reportó reciente

                (isOnSite ? onSite : offSite).push({ worker: w, latest, ageMin });

                const pos = { lat: latest.lat, lng: latest.lng };
                bounds.extend(pos);
                hasBounds = true;

                const key = String(w.id);
                seen.add(key);

                let marker = RRHH_RUNTIME.markers.get(key);
                if (!marker) {
                    marker = new google.maps.Marker({
                        map,
                        position: pos,
                        title: w.nombre
                    });
                    marker.addListener('click', () => {
                        const data = marker.__rrhh || { worker: w, latest, ageMin };
                        const when = new Date(data.latest.atIso).toLocaleString('es-GT');
                        const acc = data.latest.accuracy ? `±${Math.round(data.latest.accuracy)}m` : '';
                        RRHH_RUNTIME.infoWindow.setContent(`
                            <div style="min-width:220px;">
                                <strong>${data.worker.nombre}</strong><br>
                                <small>${data.worker.puesto}</small><br>
                                <div style="margin-top:6px;">Último GPS: ${when} (${data.ageMin} min)</div>
                                <div>Coords: ${data.latest.lat.toFixed(6)}, ${data.latest.lng.toFixed(6)} ${acc}</div>
                            </div>
                        `);
                        RRHH_RUNTIME.infoWindow.open({ anchor: marker, map });
                    });
                    RRHH_RUNTIME.markers.set(key, marker);
                } else {
                    marker.setPosition(pos);
                }

                marker.__rrhh = { worker: w, latest, ageMin };
            });

            // Remover marcadores de trabajadores que ya no estén
            for (const [id, marker] of RRHH_RUNTIME.markers.entries()) {
                if (!seen.has(id)) {
                    marker.setMap(null);
                    RRHH_RUNTIME.markers.delete(id);
                }
            }

            const renderList = (arr, emptyMsg) => {
                if (!arr.length) return `<p class="rrhh-muted">${emptyMsg}</p>`;
                return arr
                    .sort((a, b) => (a.ageMin ?? 999999) - (b.ageMin ?? 999999))
                    .map(x => {
                        if (!x.latest) return `<p><strong>${x.worker.nombre}</strong> - Sin GPS</p>`;
                        const when = new Date(x.latest.atIso).toLocaleTimeString('es-GT', { hour: '2-digit', minute: '2-digit' });
                        return `<p><strong>${x.worker.nombre}</strong> - Última actualización: ${when} (${x.ageMin} min)</p>`;
                    })
                    .join('');
            };

            if (onSiteEl) onSiteEl.innerHTML = renderList(onSite, 'Sin ubicaciones recientes');
            if (offSiteEl) offSiteEl.innerHTML = renderList(offSite, 'Sin trabajadores');

            if (hasBounds && forceFitBounds) {
                map.fitBounds(bounds);
            }
        }

        // Función para el reloj en tiempo real
        function iniciarReloj() {
            function actualizarReloj() {
                const ahora = new Date();
                const opcionesFecha = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                document.getElementById('fechaActual').textContent = 
                    ahora.toLocaleDateString('es-GT', opcionesFecha);
                document.getElementById('horaActual').textContent = 
                    ahora.toLocaleTimeString('es-GT');
            }
            
            actualizarReloj();
            intervaloReloj = setInterval(actualizarReloj, 1000);
        }

        // Función para la firma digital (corregida)
        function initApplicantSignature() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let rect = canvas.getBoundingClientRect();
            
            // Configuración inicial
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000';
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // Función para obtener posición
            function getPosition(e) {
                let clientX, clientY;
                
                if (e.type.includes('mouse')) {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else if (e.touches && e.touches[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            // Eventos de mouse
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const pos = getPosition(e);
                [lastX, lastY] = [pos.x, pos.y];
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const pos = getPosition(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            });

            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
                ctx.closePath();
            });

            canvas.addEventListener('mouseout', () => {
                isDrawing = false;
                ctx.closePath();
            });

            // Eventos táctiles
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getPosition(e);
                [lastX, lastY] = [pos.x, pos.y];
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const pos = getPosition(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                [lastX, lastY] = [pos.x, pos.y];
            });

            canvas.addEventListener('touchend', () => {
                isDrawing = false;
                ctx.closePath();
            });

            // Ajustar tamaño en redimensionamiento
            window.addEventListener('resize', () => {
                rect = canvas.getBoundingClientRect();
            });
        }

        // Limpiar firma
        function limpiarFirma() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            mostrarNotificacion('Firma limpiada correctamente', 'exito');
        }

        // Guardar firma
        function guardarFirma() {
            const canvas = document.getElementById('canvas');
            const dataURL = canvas.toDataURL('image/png');
            localStorage.setItem('firmaAplicante', dataURL);
            mostrarNotificacion('Firma guardada correctamente', 'exito');
        }

        // Cámara para selfie
        function iniciarCamara() {
            const video = document.getElementById('videoElement');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        streamCamara = stream;
                        video.srcObject = stream;
                        video.style.display = 'block';
                    })
                    .catch(function(err) {
                        console.error("Error al acceder a la cámara: ", err);
                        mostrarNotificacion('No se pudo acceder a la cámara', 'error');
                    });
            }
        }

        function capturarSelfie() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const selfieData = canvas.toDataURL('image/png');
            const preview = document.getElementById('selfiePreview');
            
            preview.src = selfieData;
            preview.style.display = 'block';
            video.style.display = 'none';
            
            localStorage.setItem('selfieAplicante', selfieData);
            mostrarNotificacion('Selfie capturada correctamente', 'exito');
        }

        function detenerCamara() {
            if (streamCamara) {
                const tracks = streamCamara.getTracks();
                tracks.forEach(track => track.stop());
                streamCamara = null;
                
                const video = document.getElementById('videoElement');
                video.srcObject = null;
                video.style.display = 'none';
            }
        }

        // Cambiar entre secciones
        function cambiarTab(tabId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(sec => {
                sec.classList.remove('activa');
            });
            
            // Remover clase activa de todas las pestañas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('activa');
            });
            
            // Mostrar sección seleccionada
            document.getElementById(`seccion-${tabId}`).classList.add('activa');
            
            // Activar pestaña seleccionada
            const tabEl = (typeof event !== 'undefined' && event && event.target) ? event.target : document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (tabEl) tabEl.classList.add('activa');

            if (history && history.replaceState) {
                history.replaceState(null, '', `#${tabId}`);
            }

            if (tabId === 'ubicacion') {
                initUbicacionTab(false);
            }

            if (tabId === 'asistencia') {
                refrescarAsistencias();
            }

            if (tabId === 'planilla') {
                calcularPlanilla();
            }
        }

        function inicializarTabDesdeHash() {
            const tabId = (window.location.hash || '').replace('#', '').trim();
            if (!tabId) return;
            const section = document.getElementById(`seccion-${tabId}`);
            const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (!section || !tab) return;
            cambiarTab(tabId);
        }

        // Funciones de navegación
        function cambiarSeccion(destino) {
            if (destino === 'inicio') {
                window.location.href = 'index.html';
            } else if (destino === 'dashboard') {
                window.location.href = 'dashboard.html';
            }
        }

        function salir() {
            if (confirm('¿Está seguro que desea salir del sistema?')) {
                window.location.href = 'index.html';
            }
        }

        // Funciones de CRUD para aplicantes
        function enviarAplicacion() {
            const nombre = document.getElementById('nombreCompleto').value;
            const puesto = document.getElementById('puesto').value;
            
            if (!nombre || !puesto) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }
            
            const nuevoAplicante = {
                id: Date.now(),
                nombre: nombre,
                puesto: puesto,
                telefono: document.getElementById('telefono').value,
                proyecto: document.getElementById('nombreProyectoContratacion').value,
                experiencia: document.getElementById('experiencia').value,
                estado: 'pendiente',
                fechaAplicacion: new Date().toISOString()
            };
            
            aplicantes.push(nuevoAplicante);
            guardarLocal();
            mostrarNotificacion('Aplicación enviada correctamente', 'exito');
            limpiarFormulario();
        }

        function aprobarContrato(id) {
            const aplicante = aplicantes.find(a => a.id === id);
            if (aplicante) {
                aplicante.estado = 'aprobado';
                aplicante.fechaContratacion = new Date().toISOString();
                
                // Generar ID único para el trabajador
                aplicante.idTrabajador = 'TRAB-' + Date.now().toString().slice(-6);
                
                guardarLocal();
                mostrarNotificacion('Contrato aprobado correctamente', 'exito');
                // En una implementación real, aquí se enviaría el link de la app de asistencia
            }
        }

        function rechazarContrato(id) {
            const aplicante = aplicantes.find(a => a.id === id);
            if (aplicante) {
                aplicante.estado = 'rechazado';
                aplicante.motivoRechazo = prompt('Ingrese motivo de rechazo:');
                guardarLocal();
                mostrarNotificacion('Contrato rechazado', 'error');
            }
        }

        function verDetallesAplicante(id) {
            const aplicante = aplicantes.find(a => a.id === id);
            if (!aplicante) {
                mostrarNotificacion('Aplicante no encontrado (id: ' + id + ')', 'error');
                return;
            }

            const detalles = [
                'ID: ' + (aplicante.idTrabajador || aplicante.id),
                'Nombre: ' + (aplicante.nombre || '—'),
                'Puesto: ' + (aplicante.puesto || '—'),
                'Teléfono: ' + (aplicante.telefono || '—'),
                'Proyecto: ' + (aplicante.proyecto || '—'),
                'Estado: ' + (aplicante.estado || '—'),
                'Aplicación: ' + (aplicante.fechaAplicacion ? new Date(aplicante.fechaAplicacion).toLocaleString() : '—'),
                'Contratación: ' + (aplicante.fechaContratacion ? new Date(aplicante.fechaContratacion).toLocaleString() : '—')
            ].join('\n');

            alert(detalles);
        }

        function desactivarContrato(id) {
            const aplicante = aplicantes.find(a => a.id === id);
            if (!aplicante) {
                mostrarNotificacion('Contrato no encontrado (id: ' + id + ')', 'error');
                return;
            }

            aplicante.estado = 'desactivado';
            aplicante.fechaDesactivacion = new Date().toISOString();
            guardarLocal();
            mostrarNotificacion('Contrato desactivado', 'error');
        }

        function reactivarContrato(id) {
            const aplicante = aplicantes.find(a => a.id === id);
            if (!aplicante) {
                mostrarNotificacion('Contrato no encontrado (id: ' + id + ')', 'error');
                return;
            }

            aplicante.estado = 'aprobado';
            delete aplicante.fechaDesactivacion;
            guardarLocal();
            mostrarNotificacion('Contrato reactivado', 'exito');
        }

        // Funciones de local storage
        function guardarLocal() {
            const datosRRHH = {
                aplicantes: aplicantes,
                trabajadoresActivos: trabajadoresActivos,
                solicitudesVacaciones: solicitudesVacaciones,
                fechaActualizacion: new Date().toISOString()
            };
            
            localStorage.setItem('rrhhData', JSON.stringify(datosRRHH));
            mostrarNotificacion('Datos guardados localmente', 'exito');
        }

        function cargarDatosLocales() {
            const datosGuardados = localStorage.getItem('rrhhData');
            if (datosGuardados) {
                const datos = JSON.parse(datosGuardados);
                aplicantes = datos.aplicantes || [];
                trabajadoresActivos = datos.trabajadoresActivos || [];
                solicitudesVacaciones = datos.solicitudesVacaciones || [];
            }
        }

        function getTrabajadoresParaVacaciones() {
            const fromTrabajadores = (trabajadoresActivos || []).map(t => ({
                id: t.idTrabajador || t.id || t.codigo || String(Date.now()),
                nombre: t.nombreCompleto || t.nombre || t.nombres || t.fullName || 'Sin nombre'
            }));

            const fromAplicantesAprobados = (aplicantes || [])
                .filter(a => a.estado === 'aprobado')
                .map(a => ({
                    id: a.idTrabajador || a.id,
                    nombre: a.nombre
                }));

            const merged = [...fromTrabajadores, ...fromAplicantesAprobados]
                .filter(t => t && t.id && t.nombre);

            const uniqueById = new Map();
            merged.forEach(t => {
                if (!uniqueById.has(String(t.id))) uniqueById.set(String(t.id), t);
            });

            return Array.from(uniqueById.values());
        }

        function calcularDiasEntreFechas(inicioISO, finISO) {
            const inicio = new Date(inicioISO + 'T00:00:00');
            const fin = new Date(finISO + 'T00:00:00');
            if (Number.isNaN(inicio.getTime()) || Number.isNaN(fin.getTime())) return 0;
            const diffMs = fin.getTime() - inicio.getTime();
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            return diffDays + 1;
        }

        function refrescarVacacionesUI() {
            const select = document.getElementById('vacTrabajador');
            const tbody = document.getElementById('vacacionesBody');
            if (!select || !tbody) return;

            const trabajadores = getTrabajadoresParaVacaciones();
            select.innerHTML = `
                <option value="">-- Seleccionar trabajador --</option>
                <option value="manual">(Escribir nombre manual)</option>
                ${trabajadores.map(t => `<option value="${String(t.id)}">${t.nombre}</option>`).join('')}
            `;

            const fmt = (iso) => {
                if (!iso) return '';
                try { return new Date(iso + 'T00:00:00').toLocaleDateString('es-GT'); } catch { return iso; }
            };

            const estadoBadge = (estado) => {
                if (estado === 'aprobado') return `<span class="estado-contrato estado-aprobado">Aprobado</span>`;
                if (estado === 'rechazado') return `<span class="estado-contrato estado-rechazado">Rechazado</span>`;
                return `<span class="estado-contrato estado-pendiente">Pendiente</span>`;
            };

            tbody.innerHTML = (solicitudesVacaciones || []).map(s => {
                const acciones = s.estado === 'pendiente'
                    ? `
                        <button class="btn-firma" onclick="aprobarSolicitudVacaciones(${s.id})" style="background: var(--verde);">Aprobar</button>
                        <button class="btn-firma" onclick="rechazarSolicitudVacaciones(${s.id})" style="background: var(--rojo);">Rechazar</button>
                      `
                    : `<span style="opacity: 0.8;">—</span>`;

                return `
                    <tr>
                        <td>${s.trabajadorNombre || ''}</td>
                        <td>${fmt(s.fechaInicio)}</td>
                        <td>${fmt(s.fechaFin)}</td>
                        <td>${s.dias || 0}</td>
                        <td>${estadoBadge(s.estado)}</td>
                        <td>${acciones}</td>
                    </tr>
                `;
            }).join('');
        }

        function limpiarFormularioVacaciones() {
            const select = document.getElementById('vacTrabajador');
            if (select) select.value = '';
            const manual = document.getElementById('vacNombreManual');
            if (manual) manual.value = '';
            const inicio = document.getElementById('vacInicio');
            if (inicio) inicio.value = '';
            const fin = document.getElementById('vacFin');
            if (fin) fin.value = '';
            const motivo = document.getElementById('vacMotivo');
            if (motivo) motivo.value = '';
        }

        function crearSolicitudVacaciones() {
            const trabajadorId = document.getElementById('vacTrabajador')?.value || '';
            const nombreManual = (document.getElementById('vacNombreManual')?.value || '').trim();
            const fechaInicio = document.getElementById('vacInicio')?.value || '';
            const fechaFin = document.getElementById('vacFin')?.value || '';
            const motivo = (document.getElementById('vacMotivo')?.value || '').trim();

            if (!fechaInicio || !fechaFin) {
                mostrarNotificacion('Seleccione fecha inicio y fecha fin', 'error');
                return;
            }

            const dias = calcularDiasEntreFechas(fechaInicio, fechaFin);
            if (dias <= 0) {
                mostrarNotificacion('Rango de fechas inválido', 'error');
                return;
            }

            let trabajadorNombre = '';
            if (trabajadorId && trabajadorId !== 'manual') {
                const trabajadores = getTrabajadoresParaVacaciones();
                trabajadorNombre = trabajadores.find(t => String(t.id) === String(trabajadorId))?.nombre || '';
            }
            if (!trabajadorNombre) trabajadorNombre = nombreManual;
            if (!trabajadorNombre) {
                mostrarNotificacion('Seleccione un trabajador o escriba el nombre', 'error');
                return;
            }

            const solicitud = {
                id: Date.now(),
                trabajadorId: trabajadorId && trabajadorId !== 'manual' ? trabajadorId : null,
                trabajadorNombre,
                fechaInicio,
                fechaFin,
                dias,
                motivo,
                estado: 'pendiente',
                createdAt: new Date().toISOString()
            };

            solicitudesVacaciones.push(solicitud);
            guardarLocal();
            refrescarVacacionesUI();
            limpiarFormularioVacaciones();
            mostrarNotificacion('Solicitud de vacaciones registrada', 'exito');
        }

        function aprobarSolicitudVacaciones(id) {
            const solicitud = (solicitudesVacaciones || []).find(s => s.id === id);
            if (!solicitud) return;
            solicitud.estado = 'aprobado';
            solicitud.updatedAt = new Date().toISOString();
            guardarLocal();
            refrescarVacacionesUI();
            mostrarNotificacion('Solicitud aprobada', 'exito');
        }

        function rechazarSolicitudVacaciones(id) {
            const solicitud = (solicitudesVacaciones || []).find(s => s.id === id);
            if (!solicitud) return;
            solicitud.estado = 'rechazado';
            solicitud.updatedAt = new Date().toISOString();
            solicitud.motivoRechazo = prompt('Motivo de rechazo (opcional):') || '';
            guardarLocal();
            refrescarVacacionesUI();
            mostrarNotificacion('Solicitud rechazada', 'error');
        }

        // Funciones de sincronización
        function sincronizarNube() {
            // Simulación de sincronización con la nube
            mostrarNotificacion('Sincronizando con la nube...', 'exito');
            
            setTimeout(() => {
                mostrarNotificacion('Datos sincronizados exitosamente', 'exito');
                
                // Generar esquema de tabla para la nube
                const esquemaTabla = {
                    nombre: "rrhh_aplicantes",
                    columnas: [
                        { nombre: "id", tipo: "INTEGER", primaryKey: true },
                        { nombre: "nombre_completo", tipo: "TEXT", notNull: true },
                        { nombre: "direccion", tipo: "TEXT" },
                        { nombre: "telefono", tipo: "TEXT" },
                        { nombre: "dpi_cui", tipo: "TEXT" },
                        { nombre: "puesto", tipo: "TEXT" },
                        { nombre: "experiencia_anios", tipo: "INTEGER" },
                        { nombre: "referencia1", tipo: "TEXT" },
                        { nombre: "referencia2", tipo: "TEXT" },
                        { nombre: "tipo_construccion", tipo: "TEXT" },
                        { nombre: "estado", tipo: "TEXT" },
                        { nombre: "proyecto_asignado", tipo: "TEXT" },
                        { nombre: "firma_digital", tipo: "TEXT" },
                        { nombre: "selfie", tipo: "TEXT" },
                        { nombre: "fecha_aplicacion", tipo: "DATETIME" },
                        { nombre: "fecha_contratacion", tipo: "DATETIME" },
                        { nombre: "id_trabajador", tipo: "TEXT" }
                    ]
                };
                
                console.log("Esquema de tabla para sincronización:", esquemaTabla);
                alert("Esquema de tabla generado para sincronización. Ver consola para detalles.");
            }, 2000);
        }

        // Funciones de impresión
        function imprimirReporte() {
            const ventanaImpresion = window.open('', '_blank');
            ventanaImpresion.document.write(`
                <html>
                <head>
                    <title>Reporte RRHH - M&S Constructora</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #001f3f; }
                        .header { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>CONSTRUCTORA WM/M&S</h1>
                        <h2>Reporte de Recursos Humanos</h2>
                        <p>Fecha: ${new Date().toLocaleDateString()} | Hora: ${new Date().toLocaleTimeString()}</p>
                    </div>
                    
                    <h3>Resumen de Aplicantes</h3>
                    <table>
                        <tr>
                            <th>Nombre</th>
                            <th>Puesto</th>
                            <th>Estado</th>
                            <th>Fecha Aplicación</th>
                        </tr>
                        ${aplicantes.map(a => `
                            <tr>
                                <td>${a.nombre}</td>
                                <td>${a.puesto}</td>
                                <td>${a.estado}</td>
                                <td>${new Date(a.fechaAplicacion).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <div style="margin-top: 50px; text-align: center; font-size: 12px;">
                        <p>Sistema de Control de Proyectos M&S - Vol 2.0</p>
                        <p>www.multiserviciosmys.com</p>
                    </div>
                </body>
                </html>
            `);
            
            ventanaImpresion.document.close();
            ventanaImpresion.print();
        }

        // Funciones auxiliares
        function mostrarNotificacion(mensaje, tipo) {
            const notificaciones = document.getElementById('notificaciones');
            const notificacion = document.createElement('div');
            notificacion.className = `notificacion ${tipo}`;
            notificacion.innerHTML = `
                <strong>${tipo === 'exito' ? '✓' : tipo === 'error' ? '✗' : '!'}</strong>
                ${mensaje}
            `;
            
            notificaciones.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.remove();
            }, 5000);
        }

        function limpiarFormulario() {
            document.getElementById('nombreCompleto').value = '';
            document.getElementById('direccion').value = '';
            document.getElementById('telefono').value = '';
            document.getElementById('dpi').value = '';
            document.getElementById('puesto').selectedIndex = 0;
            document.getElementById('experiencia').selectedIndex = 0;
            document.getElementById('referencia1').value = '';
            document.getElementById('referencia2').value = '';
            document.getElementById('tipoConstruccion').selectedIndex = 0;
            document.getElementById('aceptarHorarios').checked = false;
            document.getElementById('aceptarResponsabilidades').checked = false;
            
            const preview = document.getElementById('selfiePreview');
            preview.style.display = 'none';
            
            limpiarFirma();
            
            if (streamCamara) {
                detenerCamara();
            }
        }

        function actualizarFechaAsistencia() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaAsistencia').value = hoy;
        }

        function generarLinkAplicante() {
            const link = `https://miservicio.com/aplicacion-trabajador?id=${Date.now()}`;
            prompt('Copie este link para enviar al aplicante:', link);
            mostrarNotificacion('Link generado. Compártalo con el aplicante.', 'exito');
        }

        // Nota: la sección de Ubicación ahora usa GPS real (asistencias) + Google Maps.

        // Funciones de comunicación
        function normalizePhoneToE164GT(rawPhone) {
            const raw = String(rawPhone || '').trim();
            if (!raw) return '';

            let digits = raw.replace(/[^\d+]/g, '');
            if (digits.startsWith('+')) digits = digits.slice(1);
            digits = digits.replace(/^00/, '');
            digits = digits.replace(/^0+/, '');

            // Guatemala: si viene solo local (8 dígitos), anteponer 502
            if (/^\d{8}$/.test(digits)) digits = `502${digits}`;

            return digits;
        }

        function isValidE164Digits(digits) {
            return /^\d{8,15}$/.test(String(digits || ''));
        }

        function openWhatsApp(phoneE164Digits, text) {
            const phone = String(phoneE164Digits || '').trim();
            if (!isValidE164Digits(phone)) {
                mostrarNotificacion('Teléfono inválido para WhatsApp', 'error');
                return;
            }
            const msg = String(text || '').trim();
            const url = msg
                ? `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`
                : `https://wa.me/${phone}`;
            window.open(url, '_blank');
        }

        function openTel(phoneRaw) {
            const raw = String(phoneRaw || '').trim();
            if (!raw) {
                mostrarNotificacion('Teléfono vacío', 'error');
                return;
            }
            window.location.href = `tel:${raw}`;
        }

        function getRRHHContacts() {
            const out = [];

            // Preferir BD real (database.js)
            const db = getDB();
            if (db) {
                try {
                    const list = db.get('trabajadores') || [];
                    for (const t of list) {
                        if (!t) continue;
                        const nombre = `${t.nombre || ''} ${t.apellido || ''}`.trim() || t.nombreCompleto || t.nombres || t.fullName || 'Sin nombre';
                        const telefonoRaw = t.telefono || t.phone || t.celular || t.movil || t.whatsapp || '';
                        const telefonoE164 = normalizePhoneToE164GT(telefonoRaw);
                        out.push({
                            id: String(t.id || t.id_trabajador || nombre),
                            nombre,
                            puesto: t.puesto || '—',
                            telefonoRaw: String(telefonoRaw || '').trim(),
                            telefonoE164,
                            source: 'db'
                        });
                    }
                } catch {}
            }

            // Fallback RRHH local (rrhhData)
            for (const t of (trabajadoresActivos || [])) {
                if (!t) continue;
                const nombre = t.nombreCompleto || t.nombre || t.nombres || t.fullName || 'Sin nombre';
                const telefonoRaw = t.telefono || t.phone || t.celular || t.movil || '';
                const telefonoE164 = normalizePhoneToE164GT(telefonoRaw);
                out.push({
                    id: String(t.idTrabajador || t.id || t.codigo || nombre),
                    nombre,
                    puesto: t.puesto || '—',
                    telefonoRaw: String(telefonoRaw || '').trim(),
                    telefonoE164,
                    source: 'local'
                });
            }

            // Aplicantes aprobados (también pueden tener teléfono)
            for (const a of (aplicantes || [])) {
                if (!a || a.estado !== 'aprobado') continue;
                const nombre = a.nombre || 'Sin nombre';
                const telefonoRaw = a.telefono || '';
                const telefonoE164 = normalizePhoneToE164GT(telefonoRaw);
                out.push({
                    id: String(a.idTrabajador || a.id || nombre),
                    nombre,
                    puesto: a.puesto || '—',
                    telefonoRaw: String(telefonoRaw || '').trim(),
                    telefonoE164,
                    source: 'aplicante'
                });
            }

            // De-dup por teléfono (si existe), si no por nombre+puesto
            const byKey = new Map();
            for (const c of out) {
                const key = c.telefonoE164 ? `tel:${c.telefonoE164}` : `np:${String(c.nombre).toLowerCase()}|${String(c.puesto).toLowerCase()}`;
                if (!byKey.has(key)) byKey.set(key, c);
            }
            return Array.from(byKey.values());
        }

        const ContactPicker = {
            state: {
                onSelect: null,
                title: 'Seleccionar contacto',
                contacts: [],
                mode: 'single',
                selectedKeys: new Set(),
                confirmLabel: 'Confirmar',
                onConfirm: null,
                viewContacts: []
            },

            open({ title, contacts, onSelect, mode, confirmLabel, onConfirm }) {
                this.state.title = String(title || 'Seleccionar contacto');
                this.state.contacts = Array.isArray(contacts) ? contacts : [];
                this.state.onSelect = typeof onSelect === 'function' ? onSelect : null;
                this.state.mode = (mode === 'multi') ? 'multi' : 'single';
                this.state.confirmLabel = String(confirmLabel || (this.state.mode === 'multi' ? 'Confirmar' : 'Confirmar'));
                this.state.onConfirm = (this.state.mode === 'multi' && typeof onConfirm === 'function') ? onConfirm : null;
                this.state.selectedKeys = new Set();
                this.state.viewContacts = [];

                const overlay = document.getElementById('contactPickerOverlay');
                const titleEl = document.getElementById('contactPickerTitle');
                const search = document.getElementById('contactPickerSearch');
                const footer = document.getElementById('contactPickerFooter');
                const confirmBtn = document.getElementById('contactPickerConfirmBtn');
                const hint = document.getElementById('contactPickerFooterHint');
                if (titleEl) titleEl.textContent = this.state.title;
                if (search) search.value = '';

                if (footer) {
                    footer.style.display = (this.state.mode === 'multi') ? 'flex' : 'none';
                }
                if (confirmBtn) {
                    confirmBtn.textContent = this.state.confirmLabel;
                }
                if (hint) {
                    hint.textContent = (this.state.mode === 'multi') ? 'Seleccione uno o más contactos' : '';
                }

                this.render();

                if (overlay) {
                    overlay.style.display = 'flex';
                    overlay.setAttribute('aria-hidden', 'false');
                }
                try { search?.focus(); } catch {}
            },

            close() {
                const overlay = document.getElementById('contactPickerOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.setAttribute('aria-hidden', 'true');
                }
                this.state.onSelect = null;
                this.state.onConfirm = null;
                this.state.selectedKeys = new Set();
                this.state.viewContacts = [];
            },

            getContactKey(c) {
                const telKey = String(c?.telefonoE164 || '').trim();
                if (telKey) return `tel:${telKey}`;
                return `id:${String(c?.id || '')}`;
            },

            toggleIndex(idx) {
                const i = Number(idx);
                const c = (Number.isFinite(i) ? (this.state.viewContacts || [])[i] : null);
                if (!c) return;
                const key = this.getContactKey(c);
                if (this.state.selectedKeys.has(key)) this.state.selectedKeys.delete(key);
                else this.state.selectedKeys.add(key);
                this.render();
            },

            clearSelection() {
                this.state.selectedKeys = new Set();
                this.render();
            },

            confirm() {
                if (this.state.mode !== 'multi') return;
                const selected = (this.state.contacts || []).filter(c => this.state.selectedKeys.has(this.getContactKey(c)));
                if (!selected.length) {
                    mostrarNotificacion('Seleccione al menos un contacto', 'error');
                    return;
                }
                if (typeof this.state.onConfirm === 'function') {
                    this.state.onConfirm(selected);
                }
                this.close();
            },

            useManual() {
                const nameEl = document.getElementById('contactPickerManualName');
                const phoneEl = document.getElementById('contactPickerManualPhone');
                const nombre = String(nameEl?.value || '').trim() || 'Contacto';
                const telefonoRaw = String(phoneEl?.value || '').trim();
                const telefonoE164 = normalizePhoneToE164GT(telefonoRaw);
                if (!telefonoRaw) {
                    mostrarNotificacion('Ingrese un teléfono', 'error');
                    return;
                }
                if (!isValidE164Digits(telefonoE164)) {
                    mostrarNotificacion('Teléfono inválido. Ej: 55554444 o +50255554444', 'error');
                    return;
                }
                const c = { id: `manual:${telefonoE164}`, nombre, puesto: '—', telefonoRaw, telefonoE164, source: 'manual' };
                if (this.state.mode === 'multi') {
                    // Agregar dentro del picker y seleccionarlo
                    this.state.contacts = [...(this.state.contacts || []), c];
                    this.state.selectedKeys.add(this.getContactKey(c));
                    if (nameEl) nameEl.value = '';
                    if (phoneEl) phoneEl.value = '';
                    mostrarNotificacion('Contacto manual agregado', 'exito');
                    this.render();
                    return;
                }

                if (this.state.onSelect) this.state.onSelect(c);
                this.close();
            },

            render() {
                const listEl = document.getElementById('contactPickerList');
                const searchEl = document.getElementById('contactPickerSearch');
                const confirmBtn = document.getElementById('contactPickerConfirmBtn');
                const hint = document.getElementById('contactPickerFooterHint');
                if (!listEl) return;

                const q = String(searchEl?.value || '').trim().toLowerCase();
                const contacts = (this.state.contacts || [])
                    .filter(c => {
                        if (!q) return true;
                        const hay = `${c.nombre || ''} ${c.puesto || ''} ${c.telefonoRaw || ''} ${c.telefonoE164 || ''}`.toLowerCase();
                        return hay.includes(q);
                    })
                    .sort((a, b) => String(a.nombre || '').localeCompare(String(b.nombre || ''), 'es'));

                this.state.viewContacts = contacts;

                if (this.state.mode === 'multi') {
                    const totalSelected = (this.state.selectedKeys && typeof this.state.selectedKeys.size === 'number') ? this.state.selectedKeys.size : 0;
                    if (confirmBtn) {
                        confirmBtn.textContent = `${this.state.confirmLabel} (${totalSelected})`;
                    }
                    if (hint) {
                        hint.textContent = totalSelected ? `${totalSelected} seleccionado(s)` : 'Seleccione uno o más contactos';
                    }
                }

                if (!contacts.length) {
                    listEl.innerHTML = `<div class="contact-picker-empty">No hay contactos cargados. Agregue teléfonos en <strong>Trabajadores</strong> o use el ingreso manual.</div>`;
                    return;
                }

                listEl.innerHTML = contacts.map((c, idx) => {
                    const tel = c.telefonoRaw || (c.telefonoE164 ? `+${c.telefonoE164}` : '—');
                    const disabled = !isValidE164Digits(c.telefonoE164);
                    const btnAttrs = disabled ? 'disabled title="Este contacto no tiene un teléfono válido"' : '';
                    const key = this.getContactKey(c);
                    const checked = this.state.selectedKeys && this.state.selectedKeys.has(key);
                    const checkbox = (this.state.mode === 'multi')
                        ? `<label style="display:flex; align-items:center; gap: 10px; cursor:pointer; user-select:none;">
                                <input type="checkbox" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''} onchange="ContactPicker.toggleIndex(${idx})" />
                                <span style="opacity:0.9;">Seleccionar</span>
                           </label>`
                        : '';
                    return `
                        <div class="contact-picker-item">
                            <div>
                                <div class="contact-picker-name">${escapeHtml(c.nombre || 'Sin nombre')}</div>
                                <div class="contact-picker-meta">${escapeHtml(c.puesto || '—')} · ${escapeHtml(tel)}</div>
                            </div>
                            <div class="contact-picker-actions">
                                ${checkbox}
                                ${this.state.mode === 'single' ? `
                                    <button type="button" class="btn-firma" ${btnAttrs} onclick="ContactPicker.pickIndex(${idx})">
                                        <i class="fas fa-check"></i> Seleccionar
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            pickIndex(idx) {
                const contacts = this.state.viewContacts || [];
                const i = Number(idx);
                const c = Number.isFinite(i) ? contacts[i] : null;
                if (!c) {
                    mostrarNotificacion('No se encontró el contacto', 'error');
                    return;
                }
                if (!isValidE164Digits(c.telefonoE164)) {
                    mostrarNotificacion('El contacto no tiene teléfono válido', 'error');
                    return;
                }
                if (this.state.onSelect) this.state.onSelect(c);
                this.close();
            }
        };

        // Exponer para handlers inline (onclick="ContactPicker...")
        window.ContactPicker = ContactPicker;

        function escapeHtml(s) {
            return String(s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeAttr(s) {
            return String(s || '').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        function initContactPickerUI() {
            const overlay = document.getElementById('contactPickerOverlay');
            const search = document.getElementById('contactPickerSearch');
            if (search) {
                search.addEventListener('input', () => ContactPicker.render());
            }
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) ContactPicker.close();
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') ContactPicker.close();
            });
        }

        function abrirChatGeneral() {
            const mensaje = prompt('Mensaje para el trabajador (WhatsApp):', 'Hola, ¿podemos coordinar?');
            if (mensaje === null) return;

            const contacts = getRRHHContacts().filter(c => isValidE164Digits(c.telefonoE164));
            ContactPicker.open({
                title: 'Chat por WhatsApp (seleccione trabajador)',
                contacts,
                onSelect: (c) => {
                    openWhatsApp(c.telefonoE164, mensaje);
                    mostrarNotificacion(`Abriendo WhatsApp: ${c.nombre}`, 'exito');
                }
            });
        }

        function llamarSupervisor() {
            const all = getRRHHContacts().filter(c => String(c.telefonoRaw || c.telefonoE164 || '').trim());
            const isSupervisor = (c) => {
                const p = String(c.puesto || '').toLowerCase();
                return p.includes('supervisor') || p.includes('residente') || p.includes('encargado') || p.includes('jefe');
            };
            const preferred = all.filter(isSupervisor);
            const contacts = (preferred.length ? preferred : all)
                .map(c => ({ ...c, telefonoE164: c.telefonoE164 || normalizePhoneToE164GT(c.telefonoRaw) }))
                .filter(c => String(c.telefonoRaw || '').trim() || isValidE164Digits(c.telefonoE164));

            ContactPicker.open({
                title: preferred.length ? 'Llamar a Supervisor (seleccione)' : 'Llamar (seleccione contacto)',
                contacts,
                onSelect: (c) => {
                    openTel(c.telefonoRaw || `+${c.telefonoE164}`);
                    mostrarNotificacion(`Iniciando llamada a: ${c.nombre}`, 'exito');
                }
            });
        }

        function enviarAlertaGeneral() {
            const mensaje = prompt('Ingrese el mensaje de alerta (WhatsApp):', `ALERTA (${new Date().toLocaleString('es-GT')}): `);
            if (mensaje === null) return;

            const contacts = getRRHHContacts().filter(c => isValidE164Digits(c.telefonoE164));
            ContactPicker.open({
                title: 'Enviar alerta por WhatsApp (seleccione uno o varios)',
                contacts,
                mode: 'multi',
                confirmLabel: 'Generar envíos',
                onConfirm: (selected) => {
                    // Nota: abrir múltiples ventanas puede ser bloqueado por el navegador.
                    // Hacemos 1 auto-open y el resto los dejamos como enlaces en un prompt.
                    const safe = (selected || []).filter(c => isValidE164Digits(c.telefonoE164));
                    if (!safe.length) {
                        mostrarNotificacion('No hay contactos con teléfono válido', 'error');
                        return;
                    }

                    // Abrir el primero en nueva pestaña
                    openWhatsApp(safe[0].telefonoE164, mensaje);

                    if (safe.length === 1) {
                        mostrarNotificacion(`Alerta lista para enviar a: ${safe[0].nombre}`, 'exito');
                        return;
                    }

                    // Generar enlaces para el resto (más confiable que múltiples popups)
                    const links = safe.slice(1)
                        .map(c => `- ${c.nombre}: https://wa.me/${c.telefonoE164}?text=${encodeURIComponent(String(mensaje || '').trim())}`)
                        .join('\n');

                    prompt(
                        `Se abrió WhatsApp para 1 contacto.\n\nPara enviar al resto, copie estos links y ábralos uno por uno (o permita popups):`,
                        links
                    );

                    mostrarNotificacion(`Alerta generada para ${safe.length} trabajadores`, 'exito');
                }
            });
        }

        // Exportación/Importación
        function exportarContratosCSV() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Nombre,Puesto,Telefono,Proyecto,Estado\n"
                + aplicantes.map(a => 
                    `${a.id},${a.nombre},${a.puesto},${a.telefono},${a.proyecto},${a.estado}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "contratos_rrhh.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importarContratosCSV() {
            alert('Función de importación desde CSV - En desarrollo');
        }

        // Funciones de planilla
        function calcularPlanilla() {
            const tbody = document.getElementById('planillaBody');
            if (!tbody) {
                mostrarNotificacion('No se encontró la tabla de planilla', 'error');
                return;
            }

            const db = getDB();
            if (!db) {
                tbody.innerHTML = '<tr><td colspan="8">Base de datos no disponible</td></tr>';
                return;
            }

            const weekValue = document.getElementById('semanaPlanilla')?.value;
            if (!weekValue) {
                tbody.innerHTML = '<tr><td colspan="8">Seleccione una semana</td></tr>';
                return;
            }

            const monday = getMondayOfISOWeek(weekValue);
            if (!monday) {
                tbody.innerHTML = '<tr><td colspan="8">Semana inválida</td></tr>';
                return;
            }

            const proyectoFiltro = document.getElementById('proyectoPlanilla')?.value || 'todos';

            const workers = getActiveWorkers();
            const allAsistencias = db.get('asistencias') || [];

            const days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                return {
                    date: d,
                    ymd: formatYMDLocal(d),
                    dow: d.getDay() // 0..6
                };
            });

            const expectedWeekdayHours = 9; // 07-17 menos 1h almuerzo
            const MIN_DEDUCTION_MINUTES = 15;
            const MINUTES_PER_DAY_FOR_RATE = 8 * 60;

            let totalBruto = 0;
            let totalDeducciones = 0;
            let totalNeto = 0;

            const rows = workers.map(w => {
                const salarioDiario = Number(w.salarioDiario) || 0;
                const ratePerMinute = salarioDiario > 0 ? (salarioDiario / MINUTES_PER_DAY_FOR_RATE) : 0;

                let diasEquivalentes = 0;
                let horasTotales = 0;
                let deducciones = 0;

                for (const d of days) {
                    // Solo lunes-sábado cuentan; domingo se ignora
                    if (d.dow === 0) continue;

                    const asistencia = allAsistencias.find(a => {
                        if (!a) return false;
                        if (String(a.trabajadorId) !== String(w.id)) return false;
                        if (String(a.fecha) !== String(d.ymd)) return false;
                        if (proyectoFiltro !== 'todos' && String(a.proyectoId) !== String(proyectoFiltro)) return false;
                        return true;
                    });

                    const horas = computeWorkedHoursFromRecord(asistencia, d.ymd);
                    const workedMs = computeWorkedMsFromRecord(asistencia, d.ymd);
                    const scheduledMs = getScheduledMsForDate(d.ymd);
                    horasTotales += horas;

                    const tuvoMarca = Boolean(asistencia?.horaEntrada || asistencia?.horaSalida);
                    if (!tuvoMarca) continue;

                    // Deducción por tiempo no asistido (llegada tarde / salida temprano / ausencias parciales)
                    // Solo si la diferencia es >= 15 minutos.
                    if (ratePerMinute > 0 && scheduledMs > 0) {
                        const missingMs = Math.max(0, scheduledMs - workedMs);
                        const missingMinutes = Math.round(missingMs / 60000);
                        if (missingMinutes >= MIN_DEDUCTION_MINUTES) {
                            deducciones += (missingMinutes * ratePerMinute);
                        }
                    }

                    // Sábado: se paga como día normal (1 día) si hubo marca
                    if (d.dow === 6) {
                        diasEquivalentes += 1;
                        continue;
                    }

                    // Lunes-Viernes: día proporcional por horas, máximo 1
                    const dayEq = Math.min(1, horas / expectedWeekdayHours);
                    // Si por alguna razón no hay horas calculables pero sí marca, contar como 1 día
                    diasEquivalentes += (dayEq > 0 ? dayEq : 1);
                }

                deducciones = roundMoney(deducciones);
                const pagoSemanal = roundMoney(salarioDiario * diasEquivalentes);
                const neto = roundMoney(Math.max(0, pagoSemanal - deducciones));

                totalBruto += pagoSemanal;
                totalDeducciones += deducciones;
                totalNeto += neto;

                return `
                    <tr>
                        <td>${w.nombre}</td>
                        <td>${w.puesto}</td>
                        <td>${diasEquivalentes.toFixed(2)}</td>
                        <td>${horasTotales.toFixed(2)}</td>
                        <td>${toMoneyGTQ(salarioDiario)}</td>
                        <td>${toMoneyGTQ(pagoSemanal)}</td>
                        <td>${toMoneyGTQ(deducciones)}${deducciones > 0 ? ' <small style="opacity:0.8;">(tiempo)</small>' : ''}</td>
                        <td><strong>${toMoneyGTQ(neto)}</strong></td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.length
                ? rows.join('')
                : '<tr><td colspan="8">No hay trabajadores activos</td></tr>';

            const elBruto = document.getElementById('planillaTotalBruto');
            const elDed = document.getElementById('planillaTotalDeducciones');
            const elNeto = document.getElementById('planillaTotalNeto');
            if (elBruto) elBruto.innerHTML = `<strong>${toMoneyGTQ(totalBruto)}</strong>`;
            if (elDed) elDed.innerHTML = `<strong>${toMoneyGTQ(totalDeducciones)}</strong>`;
            if (elNeto) elNeto.innerHTML = `<strong style="color: var(--verde);">${toMoneyGTQ(totalNeto)}</strong>`;

            mostrarNotificacion('Planilla calculada exitosamente', 'exito');
        }

        function generarPagos() {
            calcularPlanilla();
            mostrarNotificacion('Órdenes de pago generadas', 'exito');
        }

        function exportarPlanillaPDF() {
            mostrarNotificacion('Generando reporte PDF de planilla...', 'exito');
            setTimeout(() => {
                mostrarNotificacion('Reporte PDF listo para descargar', 'exito');
            }, 1500);
        }

        function generarReporteAsistencia() {
            mostrarNotificacion('Reporte de asistencia generado', 'exito');
        }
    </script>
</body>
</html>